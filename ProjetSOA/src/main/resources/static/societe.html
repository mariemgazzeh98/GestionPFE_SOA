<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace Entreprise</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header-company { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; padding: 20px; border-radius: 0 0 10px 10px; margin-bottom: 30px; }
        /* Style des onglets */
        .nav-tabs .nav-link { color: #555; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-top: 3px solid #0d6efd; font-weight: bold; background-color: #fff; }
    </style>
</head>
<body>


<div class="header-company text-center">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0">üè¢ Espace Entreprise</h2>
            <small class="opacity-75">Validation directe des PFE</small>
        </div>
        <button onclick="logout()" class="btn btn-light btn-sm fw-bold text-primary">D√©connexion</button>
    </div>
</div>

<div class="container">

    <!-- Navigation Onglets -->
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#offres">1. Mes Offres</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#propositions" onclick="chargerPropositions()">2. Propositions Re√ßues</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#stagiaires" onclick="chargerStagiaires()">3. üéì Mes Stagiaires</button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- TAB 1 : PUBLIER UNE OFFRE -->
        <div class="tab-pane fade show active" id="offres">
            <div class="card p-4 shadow-sm">
                <h5 class="text-primary mb-3">‚ûï Publier un nouveau sujet</h5>
                <form onsubmit="event.preventDefault(); publierOffre();">
                    <div class="mb-3">
                        <label class="fw-bold">Titre</label>
                        <input type="text" id="titreOffre" class="form-control" placeholder="Ex: D√©veloppement Web..." required>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Description</label>
                        <textarea id="descOffre" class="form-control" rows="2" placeholder="D√©tails..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Publier</button>
                </form>
            </div>
        </div>

        <!-- TAB 2 : PROPOSITIONS RE√áUES -->
        <div class="tab-pane fade" id="propositions">
            <div class="card p-4 border-warning shadow-sm">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="text-warning-emphasis">üì© Propositions des √âtudiants</h5>
                    <button onclick="chargerPropositions()" class="btn btn-sm btn-outline-secondary">Actualiser</button>
                </div>

                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Titre</th>
                        <th>√âtudiant</th>
                        <th class="text-center">Action</th>
                    </tr>
                    </thead>
                    <tbody id="propositionsBody"></tbody>
                </table>

                <div id="msgEmptyProps" class="text-center text-muted py-3" style="display:none">
                    Aucune proposition en attente pour le moment.
                </div>
            </div>
        </div>

        <!-- TAB 3 : MES STAGIAIRES (VALID√âS DIRECTEMENT) -->
        <div class="tab-pane fade" id="stagiaires">
            <div class="card p-4 border-success shadow-sm">
                <h5 class="text-success mb-3">‚úÖ Liste des Stagiaires (Projets Valid√©s)</h5>

                <table class="table table-striped align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Projet</th>
                        <th>√âtudiant</th>
                        <th>√âtat</th>
                    </tr>
                    </thead>
                    <tbody id="stagiairesBody"></tbody>
                </table>

                <div id="msgEmptyStagiaires" class="text-center text-muted py-3" style="display:none">
                    Aucun stagiaire valid√© pour le moment.
                </div>
            </div>
        </div>

    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURATION ---
    const BASE_URL = "http://localhost:8083/api/pfe";
    const currentSocieteId = localStorage.getItem('userId') || 1;

    // 1. PUBLIER OFFRE
    async function publierOffre() {
        const data = {
            titre: document.getElementById("titreOffre").value,
            description: document.getElementById("descOffre").value,
            societeId: currentSocieteId
        };
        try {
            const res = await fetch(`${BASE_URL}/societe/${currentSocieteId}/add`, {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data)
            });
            if(res.ok) {
                alert("‚úÖ Offre publi√©e !");
                document.getElementById("titreOffre").value = "";
                document.getElementById("descOffre").value = "";
            }
        } catch (e) { alert("Erreur serveur"); }
    }

    // 2. CHARGER PROPOSITIONS (Onglet 2)
    async function chargerPropositions() {
        const tbody = document.getElementById("propositionsBody");
        tbody.innerHTML = "";
        try {
            const res = await fetch(`${BASE_URL}/societe/${currentSocieteId}/propositions`);
            const data = await res.json();

            if (data.length === 0) { document.getElementById("msgEmptyProps").style.display = "block"; return; }
            document.getElementById("msgEmptyProps").style.display = "none";

            data.forEach(p => {
                const nomEtu = p.etudiant ? p.etudiant.nom : "Inconnu";
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">${p.titre}</td>
                        <td>${nomEtu}</td>
                        <td class="text-center">
                            <button class="btn btn-success btn-sm me-1" onclick="valider(${p.id}, true)">‚úÖ Embaucher</button>
                            <button class="btn btn-danger btn-sm" onclick="valider(${p.id}, false)">‚ùå Refuser</button>
                        </td>
                    </tr>`;
            });
        } catch (e) { console.error(e); }
    }

    // 3. CHARGER STAGIAIRES (Onglet 3)
    async function chargerStagiaires() {
        const tbody = document.getElementById("stagiairesBody");
        tbody.innerHTML = "";
        try {
            // R√©cup√®re les projets 'AFFECTE' li√©s √† cette soci√©t√©
            const res = await fetch(`${BASE_URL}/societe/${currentSocieteId}/stagiaires`);
            const data = await res.json();

            if (data.length === 0) { document.getElementById("msgEmptyStagiaires").style.display = "block"; return; }
            document.getElementById("msgEmptyStagiaires").style.display = "none";

            data.forEach(p => {
                const nomEtu = p.etudiant ? p.etudiant.nom : "Inconnu";
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${p.titre}</td>
                        <td><span class="badge bg-primary text-wrap">${nomEtu}</span></td>
                        <td><span class="badge bg-success">CONFIRM√â (AFFECT√â)</span></td>
                    </tr>`;
            });
        } catch (e) { console.error(e); }
    }

    // ACTION : VALIDER (Directement en AFFECTE)
    async function valider(id, accepte) {
        if(!confirm(accepte ? "Confirmer ce stagiaire ?" : "Refuser ce projet ?")) return;
        try {
            const res = await fetch(`${BASE_URL}/societe/valider/${id}?accepte=${accepte}`, { method: "PUT" });
            if(res.ok) {
                alert("‚úÖ Enregistr√© !");
                chargerPropositions(); // Rafra√Æchir la liste des propositions
            } else {
                alert("Erreur technique");
            }
        } catch (e) { alert("Erreur serveur"); }
    }

    function logout() { window.location.href = "login.html"; }
</script>
</body>
</html>