<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Enseignant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-custom { box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: none; background: white; padding: 20px; border-radius: 10px; }
        .badge-status { font-size: 0.9em; padding: 8px 12px; }
    </style>
</head>
<body class="container mt-5">

<!-- En-t√™te -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-primary">üë®‚Äçüè´ Tableau de Bord Enseignant</h2>
        <p class="text-muted">G√©rez les demandes de PFE et suivez vos √©tudiants.</p>
    </div>
    <div>
        <button onclick="logout()" class="btn btn-danger">D√©connexion</button>
    </div>
</div>

<div class="d-flex justify-content-end mb-3">
    <button onclick="chargerTout()" class="btn btn-primary">üîÑ Actualiser</button>
</div>

<!-- Tableau des Demandes -->
<div class="card-custom mb-5">
    <h4 class="mb-3">Demandes en attente</h4>
    <table class="table table-hover align-middle">
        <thead class="table-dark">
        <tr>
            <th style="width: 30%;">Projet</th>
            <th style="width: 20%;">√âtudiant</th>
            <th style="width: 20%;">Soci√©t√©</th>
            <th style="width: 15%;">√âtat</th>
            <th style="width: 15%;">Actions</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <!-- JS -->
        </tbody>
    </table>
    <div id="loadingMessage" class="text-center text-muted mt-3" style="display:none;">Chargement...</div>
    <div id="emptyMessage" class="text-center text-muted mt-3" style="display:none;">Aucune demande en attente.</div>
</div>

<!-- Tableau des √âtudiants Accept√©s -->
<div class="card-custom">
    <h4 class="mb-3 text-success">Mes √âtudiants Encadr√©s</h4>
    <table class="table table-striped table-bordered">
        <thead class="table-success">
        <tr>
            <th>Projet</th>
            <th>√âtudiant</th>
            <th>Soci√©t√©</th>
            <th>√âtat</th>
        </tr>
        </thead>
        <tbody id="etudiants-body">
        <!-- JS -->
        </tbody>
    </table>
</div>

<!-- JavaScript -->
<script>
    // --- CONFIGURATION ---
    const BASE_URL = "http://localhost:8083";

    // Simule l'ID (Login)
    const currentProfId = localStorage.getItem('userId') || 1; // ID 1 par d√©faut pour test

    document.addEventListener("DOMContentLoaded", chargerTout);

    function chargerTout() {
        chargerDashboard();
        chargerEtudiantsAcceptes();
    }

    // --- 1. CHARGER DEMANDES EN ATTENTE ---
    function chargerDashboard() {
        const tbody = document.getElementById('tableBody');
        const emptyMsg = document.getElementById('emptyMessage');
        tbody.innerHTML = "";
        emptyMsg.style.display = "none";

        // URL correspondant au controller: @GetMapping("/{enseignantId}/demandes")
        fetch(`${BASE_URL}/api/enseignant/${currentProfId}/demandes`)
            .then(response => response.json())
            .then(data => {
                if (!data || data.length === 0) {
                    emptyMsg.style.display = "block";
                    return;
                }
                data.forEach(projet => afficherLigneProjet(projet, tbody));
            })
            .catch(err => console.error("Erreur dashboard:", err));
    }

    function afficherLigneProjet(projet, tbody) {
        const nomEtudiant = projet.etudiant ? projet.etudiant.nom : 'Inconnu';
        const nomSociete = projet.societe ? projet.societe.nom : 'Non sp√©cifi√©';

        const row = `
            <tr>
                <td><strong>${projet.titre}</strong></td>
                <td>${nomEtudiant}</td>
                <td>${nomSociete}</td>
                <td><span class="badge bg-warning text-dark">${projet.etat}</span></td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="prendreDecision(${projet.id}, true)">‚úÖ</button>
                    <button class="btn btn-danger btn-sm" onclick="prendreDecision(${projet.id}, false)">‚ùå</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    }

    function prendreDecision(projetId, estAccepte) {
        if (!confirm(`Confirmer cette action ?`)) return;

        fetch(`${BASE_URL}/api/enseignant/decision/${projetId}?accepte=${estAccepte}`, {
            method: 'PUT'
        })
        .then(res => {
            if (res.ok) {
                alert("Action enregistr√©e !");
                chargerTout();
            } else {
                alert("Erreur serveur");
            }
        });
    }

    // --- 2. CHARGER √âTUDIANTS ACCEPT√âS ---
    function chargerEtudiantsAcceptes() {
        // URL correspondant au controller: @GetMapping("/{enseignantId}/etudiants")
        fetch(`${BASE_URL}/api/enseignant/${currentProfId}/etudiants`)
            .then(response => {
                if (!response.ok) throw new Error("Erreur");
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById("etudiants-body");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center">Aucun √©tudiant encadr√© pour le moment.</td></tr>`;
                    return;
                }

                data.forEach(projet => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${projet.titre}</td>
                    <td>${projet.etudiant ? projet.etudiant.nom : "‚Äî"}</td>
                    <td>${projet.societe ? projet.societe.nom : "‚Äî"}</td>
                    <td><span class="badge bg-success">${projet.etat}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error(error);
                document.getElementById("etudiants-body").innerHTML = `<tr><td colspan="4" class="text-danger text-center">Erreur de chargement</td></tr>`;
            });
    }

    function logout() {
        localStorage.removeItem('userId');
        window.location.href = 'login.html';
    }
</script>
</body>
</html>